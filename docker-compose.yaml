version: "3.7"

services:
  bitcoind:
    image: cryptodockerhub/bitcoin-core:latest
    container_name: bitcoind
    restart: always
    ports:
      - 8332:8332
      - 8333:8333
      - 18332:18332
      - 18333:18333
      - 18443:18443
      - 18444:18444
    volumes:
      - ./chain:/home/coinuser/.bitcoin
      - ./config/bitcoin.conf:/data/config.conf
    command: 
      -chain=test
      -printtoconsole
      -dnsseed=0
      -fixedseeds=0
      -conf=/data/config.conf
    networks:
      - bitcoin
  bitcoin-node-manager:
    image: php:8.2-apache
    container_name: bitcoin-node-manager
    ports:
      - 8000:80
    volumes:
      - ./bitcoin-node-manager:/var/www/html
    networks: 
      - bitcoin
  cpuminer:
    container_name: cpuminer
    restart: on-failure
    build:
      context: .
      dockerfile: Dockerfile.cpuminer
    image: cpuminer
    volumes:
      - ./config/cpuminer.conf:/app/cpuminer.conf
    entrypoint: ./minerd -c /app/cpuminer.conf --coinbase-addr=myZ5YPgGzzUXBTf4vSNpq3WHRoDcSUhFYL
    networks:
      - bitcoin
  cgminer:
    container_name: cgminer
    restart: on-failure
    build:
      context: .
      dockerfile: Dockerfile.cgminer
    image: cgminer
    volumes:
      - ./config/cgminer.conf:/app/cgminer.conf
    entrypoint: ./cgminer -c /app/cgminer.conf
    ports:
          - 4028:4028
    networks:
      - bitcoin
  bfgminer:
    container_name: bfgminer
    build:
      context: .
      dockerfile: Dockerfile.bfgminer
    image: bfgminer
    entrypoint: ./bfgminer -S opencl:auto -S cpu:auto --generate-to=myZ5YPgGzzUXBTf4vSNpq3WHRoDcSUhFYL
    volumes:
      - ./config/bfgminer.conf:/app/bfgminer.conf
    networks:
      - bitcoin
  stratum:
    container_name: stratum
    build:
      context: .
      dockerfile: Dockerfile.stratum
    image: stratum
    ports:
      - 8008:8000
      - 3333:3333
    working_dir: /app/stratum-mining
    entrypoint: twistd -ny launcher.tac
    # entrypoint: ./stratum-mining.py -o localhost:8332 -u n3uD1TSmc2HNs4bonnnBtURURLqqmcHnYd -p x
    volumes:
      - ./config/stratum.py:/app/stratum-mining/conf/config.py
    networks:
      - bitcoin
  stratumdb:
    image: mysql:latest
    container_name: stratumdb
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=stratum
      - MYSQL_DATABASE=stratum
      - MYSQL_USER=stratum
      - MYSQL_PASSWORD=stratum
    ports:
      - 3306:3306
    volumes:
      - ./db:/var/lib/mysql
      - ./migration/stratum.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - bitcoin
networks:
  bitcoin:
    name: bitcoin
    driver: bridge